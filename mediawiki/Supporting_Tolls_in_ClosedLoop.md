This is a guide to developers/modelers about the changes made to mitsim
on the new feature to support tolls in closedloop.

## Basic Info

Track identifier: CL_Toll_Apr2015

Date completed: 5-May-2015

Repostory: FM-SMART Git, repo "mitsim", branch
"cl_route_choice_with_toll"

Feature Descriptions:

  - Mitsim would take one more guidance file (toll.dat) in closed loop,
    in addition to traditional DynaMIT's predicted travel times.
  - Toll values are used in utililty calculation of route choice models,
    via the concept of *value of time* (vot).
  - Both route choice models are affected by the change, route switching
    and dynamic shortest path, and the effect applies to both pretrip
    and enroute.

## User Guide

### master.mitsim

In open loop, specifying below option in master.mitsim
**\[OpenLoopToll\] = "toll file name"** instructs Mitsim to read the
"static" toll file. The toll file specifies time-dependent toll values
used by the route choice models.

In closed loop, specifying below option in master.mitsim
**\[ClosedLoopToll\] = "toll file name"** instructs Mitsim to read the
toll file generated by DynaMIT. The toll file specifies time-dependent
toll values used by the route choice models. DynaMIT may also provide
Mitsim with ClosedLoopGuidance (predicted travel times) at the same
time.

If master.mitsim doesn't contain any specification of toll file, Mitsim
would assume there're no tolls on all segments, regardless of open or
closed loop.

### Models and parameters

Formula used for determining probability of route *i* for vehicle *v*:

  -
    cost\[*route i*\] = beta_tt \* travel_time + beta_tt \* 3600 \*
    toll_dollar_value / vot_v,

where vot_v is the value of time of vehicle *v*.

The probablity of route *i* being chosen is proportional to its utility,
where utility\[*route i*\] = exp(cost)

Sample parameters in paralib.dat:

    [Route Choice] = {
    %   Fraction    Beta
        0.2     -0.008
        0.8     -0.008
    }

    [VOT Toll Dis] = {
    %   mean    stddev  ub  lb
        23.5    5.75    40  5
    }

### Toll file format

It is quite similar to linktime file format, i.e., also has a header
section and data section. The header section specifies toll start time,
number of tolled links, and tolling interval length (usually same as OD
interval lengh). The data section is similar to csv data. Each line
starts with tolling interval start time, followed by a list of link_id
toll_dollar_value tuples.

### Example

Finally, an open-loop example is available in
![<File:example_mitsim.zip>](example_mitsim.zip
"File:example_mitsim.zip").

## Developer Guide

### Changed Source Files

The udpated source files mainly reside in two folders: "TS" and "GRN".
For more details please look into below commits (ordered reverse
chronologically):

  - d34c0d472c
  - 07273ddd42
  - d5e562e877

Below lists some key files and their roles:

  - GRN/RN_LinkCost.h/cc - represents which link has toll and
    (time-dependent) toll values
  - GRN/RN_Vehicle.h/cc and GRN/RN_Node.h/cc - implements route
    switching model
  - GRN/RN_Route.h/cc - implements dynamit shortest path model from
    historical travel times and given tolls
  - GRN/RN_DynamicRoute.h/cc - implements dynamit shortest path model
    from simulated travel times (or guidance file from closed loop) and
    given tolls
  - Templates/Graph.h/cc - computing structure of dynamit shortest path