This page intends to be a user guide rather than a theoretical session.
We mainly focus on how to set up and run DynaMIT-R with online
calibration capability. Note online calibration is still at experimental
phase, and we've been trying various methods and checking their
performance, and the procedures are a bit complex and are not matured.
To set up and run it in your environment, you might run into unexpected
situations which are not covered by this page, please consult DynaMIT
developers/modellers for help.

## Overview

Online calibration is the process of estimating od flows and simulation
parameters for the current simulation interval, so that predictions
could be more accurate. Currently the estimation process is formed as a
state space problem and we use Extended Kalman Filter (EKF) algorithm to
get the best estimates. The state vector (*x*) may consist of:

  - OD flow vector for current interval t
  - Supply parameters
  - Behavioral parameters

The measurements (*y*) are sensor readings, such as speed / flows at
some segments.

The problem is formulated in terms of deviations from historical values.
Suppose we only consider the past interval,

    dxt = F1 dxt-1 + w
    dyt = f(dxt) + v

Given the problem abstraction, we use EKF to estimate *x*. During the
linearization phase, we used (some variant of) SPSA or Finite Difference
method to calculate the Jacobian matrix.

## The calibration process

The EKF procedure is implemented in matlab scripts (onlineCalib.m), and
DynaMIT-R communicates with it via matlab engine or via mcc, depending
on how DynaMIT is built. During Jacobian matrix calculation, several
DynaMIT supply runs are required. The matlab script does this by running
a different DynaMIT executable from clones of the original DynaMIT
folder. Online calibration could also benefit from a multi-core computer
by running simulation in parallel, with the help of Matlab Parallel
Toolbox.

Calibration in detail: [Ravi's document to be
added](Ravi's_document_to_be_added "wikilink")

## User guide

### Different configurations of online calibration

Currently we're experimenting a number of different configurations of
calibration, and examining their performance:

  - Simultanous calibration of both demand and supply parameters
  - Two step calibration, supply followed by demand:
      - supply via EKF and demand via EKF
      - supply via EKF and demand via GLS

In addition, when calibrating OD with EKF method, there's an option to
use assignment matrix generated by DynaMIT instead of calculating
Jocabian matrix on the run. All variantions are configured in the
dtaparam.dat file. The options are described below:

| Option                                                   | Description                                                                                                                                                                                 |
| -------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| <font color="Indigo">EnableOnlineCalibration</font>      | *Main switch; setting it to 0 turns off online calibration (leaving only od estimation is performed), otherwise online calibration would take place*                                        |
| <font color="Indigo">CalibrationScriptName</font>        | *Online calibration script name (without the .m suffix, no path is supported. It means oc script has to sit in the same DynaMIT working directory)*                                         |
| <font color="Indigo">CalibrationWarmupIntervals</font>   | *Number of warmup intervals before online calibration kicks off. In warmup intervals only od estimations are performed*                                                                     |
| <font color="Indigo">CalibrationLookbackIntervals</font> | *Autogressive degree for online calibration. It should be less than or equal to warmup intervals.*                                                                                          |
| <font color="Indigo">TwoStageCalibration</font>          | *Switch for two step calibration; setting it to 0 indicates that supply and demand parameters are calibrated simultanously, otherwise supply would be calibrated first, followed by demand* |
| <font color="Indigo">CalibrateODWithGLS</font>           | *Only effective for two step calibration; if it's set to 1, demand estimation is done by GLS rather than EKF*                                                                               |
| <font color="Indigo">UseDynaMITAssignmentMatrix</font>   | *Only effective when demand calibration is done by EKF; when it's set to 1 DynaMIT would provide assignment matrix to be used as (at least part of) Jocobian matrix in the EKF*             |
| <font color="Indigo">CalibrateSupply</font>              | *Only effective in simultanous calibration; when it's set to 0 it acts like a hack to disable supply calibration such that only demand will be calibated*                                   |

### Run DynaMIT-R with online calibration

-----

In short, you need to prepare DynaMIT intputs, build your DynaMIT
executable, get the OC scripts, adjust settings and run it.

  - For DynaMIT input files, refer to **"the"** user manual.

<!-- end list -->

  - For builing the proper version of DynaMIT, refer to [Programmer
    Guide](DynaMIT_2.0_Programmer_Guide "wikilink"). Basically you could
    choose to build the *Matlab Engine* version or the *mcc* version.

<!-- end list -->

  - You can find the oc scripts at SourceCode/scritps/OnlineCalib of
    DynaMIT code repository. Copy them to your DynaMIT working folder.
    If you are using mcc approach, first compile OC_Calib.m into an
    executable named "onlineCalib", and copy the compiled executable
    into DynaMIT working folder.

<!-- end list -->

  - Depending on your purpose, you might want to adjust some
    calibration-specific settings in OC_config.m (may also need to
    regenerate algoParams.mat).

<!-- end list -->

  - Set desired configurations in dtaparam.dat and you're ready to run.
    Please refer to the [Programmer
    Guide](DynaMIT_2.0_Programmer_Guide "wikilink") for running DynaMIT.
    Do remember to set up MCR environment before running it.

An example of DynaMIT working directory is available
[here](DynaMIT_2.0_Demo_Package "wikilink").